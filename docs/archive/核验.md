# 🧠 模型架构与数据流（RGB + Spike → 特征提取 → 融合 → 解码输出）

---

## 1️⃣ 输入与时间对齐阶段（Input Alignment）

| 输入项          | 说明        | 数据形状                                 | 处理                                       |
| ------------ | --------- | ------------------------------------ | ---------------------------------------- |
| **模糊帧 Bₜ**   | 模糊的RGB帧   | `[B, 3, H, W]`                       | 输入到VRT编码器（Video Restoration Transformer） |
| **Spike流 S** | 连续的脉冲事件序列 | `[B, T, H, W]` 或事件流 `{(x, y, t, p)}` | 与RGB帧时间窗 `[t₀, t₁]` 对齐                   |

**时间窗对齐（Temporal Alignment）：**

```text
Spike流 S → 对齐到 RGB帧曝光时间 [t₀, t₁]
```

输出：对齐后的 Spike 子序列 ( S_{[t₀,t₁]} )

---

## 2️⃣ Spike 表征转换阶段（Spike Representation）

| 模块                      | 输入             | 输出             | 说明                    |
| ----------------------- | -------------- | -------------- | --------------------- |
| **体素化 (Voxelization)**  | `[B, T, H, W]` | `[B, K, H, W]` | 将时间窗口内的事件分桶（K为离散时间步数） |
| **归一化 (Normalization)** | `[B, K, H, W]` | `[B, K, H, W]` | 线性/标准化，使不同时间段的激活幅度可比  |

输出给 **SpikeEncoder3D**

---

## 3️⃣ 特征提取阶段（Encoders）

并行两路编码器：

| 模块                 | 输入             | 输出                   | 说明                         |
| ------------------ | -------------- | -------------------- | -------------------------- |
| **VRT RGB 编码器**    | `[B, 3, H, W]` | `{Fᵣ¹, Fᵣ², …, Fᵣᴸ}` | L层特征图；每层对应不同尺度（多尺度金字塔）     |
| **SpikeEncoder3D** | `[B, K, H, W]` | `{Fₛ¹, Fₛ², …, Fₛᴸ}` | 3D卷积提取时空特征，与VRT输出在空间分辨率上对齐 |

形状示例：

```text
Fᵣ¹: [B, C₁, H, W]
Fᵣ²: [B, C₂, H/2, W/2]
…
Fₛ¹: [B, C₁, H, W]
Fₛ²: [B, C₂, H/2, W/2]
```

---

## 4️⃣ 解码与融合阶段（Decoder & Fusion）

### (1) TMSA 内部特征对齐（多尺度注意力）

| 模块                       | 输入         | 输出          | 说明                                                |
| ------------------------ | ---------- | ----------- | ------------------------------------------------- |
| **RGB TMSA 并行对齐**        | `{Fᵣ¹..L}` | `{Fᵣ′¹..L}` | Temporal Multi-Scale Attention，对RGB帧内部多尺度特征进行时序建模 |
| **Spike Self-Attention** | `{Fₛ¹..L}` | `{Fₛ′¹..L}` | Spike内部特征的时空关联建模                                  |

输出：

```text
Fᵣ′[1..L], Fₛ′[1..L]
```

---

### (2) Cross-Attention 融合（最终融合模块）

| 模块             | 输入                 | 输出          | 注意力方向             |
| -------------- | ------------------ | ----------- | ----------------- |
| **Cross-Attn** | Q = Fᵣ′, K/V = Fₛ′ | `{F𝑓¹..L}` | 用Spike特征引导RGB特征融合 |

输出：

```text
F𝑓¹..L : [B, Cₗ, Hₗ, Wₗ]
```

---

### (3) 多尺度解码与跳连（Decoder Fusion）

| 模块                             | 输入          | 输出             | 说明                   |
| ------------------------------ | ----------- | -------------- | -------------------- |
| **多尺度解码器 (Upsampling + Skip)** | `{F𝑓¹..L}` | `[B, 3, H, W]` | 逐层上采样与Skip连接，生成最终复原图 |
| **输出帧**                        | -           | `Ĩₜ`           | 复原清晰帧，与输入模糊帧Bₜ形状相同   |

---

## 5️⃣ 损失函数阶段（Loss Functions）

| 模块                          | 输入                                | 输出        | 说明               |
| --------------------------- | --------------------------------- | --------- | ---------------- |
| **感知损失 (VGG)**              | `(Ĩₜ, Iₜ)`                        | `ℒ_vgg`   | 通过VGG特征空间计算感知一致性 |
| **重建损失 (Charbonnier / L1)** | `(Ĩₜ, Iₜ)`                        | `ℒ_recon` | 像素级精度约束          |
| **总损失**                     | `ℒ_total = λ₁·ℒ_vgg + λ₂·ℒ_recon` | -         | 加权求和后反向传播        |

---

## 📊 总体数据流形状概览（单样本）

| 阶段  | 名称       | 数据形状               | 说明          |
| --- | -------- | ------------------ | ----------- |
| 输入  | 模糊帧 Bₜ   | `[3, H, W]`        | RGB输入       |
| 输入  | Spike流 S | `[K, H, W]`        | 时间维度K表示帧分辨率 |
| 编码后 | Fᵣ¹..L   | `[Cₗ, H/2ˡ, W/2ˡ]` | RGB多尺度特征    |
| 编码后 | Fₛ¹..L   | `[Cₗ, H/2ˡ, W/2ˡ]` | Spike多尺度特征  |
| 融合后 | F𝑓¹..L  | `[Cₗ, H/2ˡ, W/2ˡ]` | 融合特征        |
| 解码后 | Ĩₜ       | `[3, H, W]`        | 重建输出        |

---

## 🧱 模块与代码接口对应建议

| 图中模块名            | 应在代码中体现为                               | 输入形状           | 输出形状           |
| ---------------- | -------------------------------------- | -------------- | -------------- |
| `VRT RGB 编码器`    | `VRTEncoder` 或 `VRTEncoder_RGB`        | `[B, 3, H, W]` | `{Fᵣ¹..L}`     |
| `SpikeEncoder3D` | `SpikeEncoder3D`                       | `[B, K, H, W]` | `{Fₛ¹..L}`     |
| `Cross-Attn`     | `CrossAttentionFusion`                 | Q=Fᵣ′, K/V=Fₛ′ | `{F𝑓¹..L}`    |
| `Decoder`        | `MultiScaleDecoder`                    | `{F𝑓¹..L}`    | `[B, 3, H, W]` |
| `Loss`           | `VGGPerceptualLoss`, `CharbonnierLoss` | `[B, 3, H, W]` | scalar         |

---

## ✅ 总结（流水线一行式）

```
模糊帧 Bₜ
 + Spike 流 S
   ↓
时间窗对齐 → Spike体素化/归一化
   ↓
VRT RGB 编码器 → Fᵣ[1..L]
SpikeEncoder3D → Fₛ[1..L]
   ↓
TMSA & Self-Attn
   ↓
Cross-Attn (融合)
   ↓
多尺度解码 + 跳连
   ↓
复原输出 Ĩₜ
   ↓
VGG感知 + Charbonnier/L1 损失
```

