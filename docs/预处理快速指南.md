# 预处理快速指南

## 快速开始

### TL;DR

```bash
# 检查数据集是否已准备好
python -m src.data.preprocessing --dataset gopro \
    --data-root /path/to/raw --output-root data/processed/gopro_unified \
    --action check

# 准备数据集（如果未准备好）
python -m src.data.preprocessing --dataset gopro \
    --data-root /path/to/raw --output-root data/processed/gopro_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --action prepare

# 开始训练（如果启用了 AUTO_PREPARE，数据集会自动检查）
python src/train.py --config configs/deblur/vrt_spike_baseline.yaml
```

---

## 命令示例

### GoPro 数据集

**完整预处理流程**：
```bash
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --action prepare
```

**仅检查数据集就绪状态**：
```bash
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --action check
```

**仅计算统计信息**：
```bash
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --action stats
```

### X4K 数据集

**完整预处理流程**：
```bash
python -m src.data.preprocessing \
    --dataset x4k \
    --data-root /mnt/data/x4k1000fps \
    --output-root data/processed/x4k_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --action prepare
```

**仅检查数据集就绪状态**：
```bash
python -m src.data.preprocessing \
    --dataset x4k \
    --data-root /mnt/data/x4k1000fps \
    --output-root data/processed/x4k_unified \
    --action check
```

---

## 配置文件设置

### 启用自动预处理

编辑 `configs/deblur/vrt_spike_baseline.yaml`：

```yaml
DATA:
  ROOT: data/processed/gopro_spike_unified
  
  PREPROCESSING:
    AUTO_PREPARE: true          # ← 设置为 true 启用自动预处理
    DATASET_TYPE: "gopro"       # 数据集类型: "gopro" 或 "x4k"
    FORCE_RECOMPUTE: false      # 是否强制重新计算
    
    VOXEL:
      NUM_BINS: 32              # Voxel 分箱数量
      APPLY_LOG1P: true         # 是否应用 log1p 变换
      CACHE_DIRNAME: "spike_vox"  # Voxel 缓存目录名
    
    GOPRO:
      SPIKE_TEMPORAL_FRAMES: 10  # Spike 数据时间帧数
      SPIKE_HEIGHT: 396          # Spike 数据高度
      SPIKE_WIDTH: 640           # Spike 数据宽度
    
    X4K:
      FPS: 1000                  # 源视频帧率
      EXPOSURE_FRAMES: 33        # 用于合成模糊的帧数
```

启用后，训练时会自动检查和准备数据集：
```bash
python src/train.py --config configs/deblur/vrt_spike_baseline.yaml
```

---

## Python API

### 基本用法

```python
from pathlib import Path
from src.data.preprocessing import get_preprocessor

# 创建预处理器
preprocessor = get_preprocessor(
    dataset_type="gopro",
    data_root=Path("/path/to/raw"),
    output_root=Path("data/processed/gopro_unified"),
    config_path=Path("configs/deblur/vrt_spike_baseline.yaml"),
)

# 检查数据集是否准备好
if not preprocessor.check_ready():
    print("数据集未准备好，开始预处理...")
    # 准备数据
    preprocessor.prepare()
else:
    print("✓ 数据集已准备好")
```

### 高级用法

```python
from pathlib import Path
from src.data.preprocessing import get_preprocessor

# GoPro 数据集 - 自定义参数
gopro_preprocessor = get_preprocessor(
    dataset_type="gopro",
    data_root=Path("/mnt/data/gopro_spike"),
    output_root=Path("data/processed/gopro_unified"),
    config_path=Path("configs/deblur/vrt_spike_baseline.yaml"),
    # GoPro 特定参数
    spike_frames=10,      # Spike 时间帧数
    spike_height=396,     # Spike 高度
    spike_width=640,      # Spike 宽度
    num_bins=32,          # Voxel 分箱数
)

# 完整预处理流程
gopro_preprocessor.prepare()

# 计算统计信息
stats = gopro_preprocessor.compute_stats()
print(f"Spike 均值: {stats['spike_mean']}")
print(f"Spike 标准差: {stats['spike_std']}")

# 更新配置文件
gopro_preprocessor.update_config(stats)
```

```python
# X4K 数据集
x4k_preprocessor = get_preprocessor(
    dataset_type="x4k",
    data_root=Path("/mnt/data/x4k1000fps"),
    output_root=Path("data/processed/x4k_unified"),
    config_path=Path("configs/deblur/vrt_spike_baseline.yaml"),
    # X4K 特定参数
    fps=1000,             # 源视频帧率
    exposure_frames=33,   # 用于合成模糊的帧数
    num_bins=32,          # Voxel 分箱数
)

x4k_preprocessor.prepare()
```

---

## 预期目录结构

### 输入（原始数据）

**GoPro 数据集**：
```
data/raw/gopro_spike/
├── train/
│   ├── GOPR0372_07_00/
│   │   ├── blur/
│   │   │   ├── 000001.png
│   │   │   ├── 000002.png
│   │   │   └── ...
│   │   ├── sharp/
│   │   │   ├── 000001.png
│   │   │   ├── 000002.png
│   │   │   └── ...
│   │   └── spike/
│   │       ├── 000001.dat
│   │       ├── 000002.dat
│   │       └── ...
│   ├── GOPR0372_07_01/
│   └── ...
└── val/
    └── ...
```

**X4K 数据集**：
```
data/raw/x4k/
├── train/
│   ├── scene_001/
│   │   ├── sharp/
│   │   │   ├── frame_0001.png
│   │   │   ├── frame_0002.png
│   │   │   └── ...
│   │   └── spike/
│   │       ├── spike_0001.npy
│   │       ├── spike_0002.npy
│   │       └── ...
│   ├── scene_002/
│   └── ...
└── val/
    └── ...
```

### 输出（预处理后的数据）

```
data/processed/{dataset}_unified/
├── train/
│   ├── blurry/                 # 模糊的 RGB 图像
│   │   ├── scene_000_frame_001.png
│   │   ├── scene_000_frame_002.png
│   │   └── ...
│   ├── sharp/                  # 清晰的 RGB 图像
│   │   ├── scene_000_frame_001.png
│   │   ├── scene_000_frame_002.png
│   │   └── ...
│   └── spike_vox/              # Voxel 化的 spike 数据
│       ├── scene_000_frame_001.npy
│       ├── scene_000_frame_002.npy
│       └── ...
├── val/
│   ├── blurry/
│   ├── sharp/
│   └── spike_vox/
└── stats.json                  # 数据集统计信息
```

**stats.json 示例**：
```json
{
    "spike_mean": [0.123, 0.456, ...],  # 每个 bin 的均值
    "spike_std": [0.789, 0.012, ...],   # 每个 bin 的标准差
    "spike_min": -1.234,                 # 最小值
    "spike_max": 5.678,                  # 最大值
    "num_samples": 2103,                 # 样本数量
    "splits": ["train", "val"]           # 数据集划分
}
```

---

## 命令行参数

### 通用参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--dataset` | 数据集类型：`gopro` 或 `x4k` | **必需** |
| `--data-root` | 原始数据路径 | **必需** |
| `--output-root` | 预处理输出路径 | **必需** |
| `--action` | 操作类型：`prepare`, `check`, `stats` | `prepare` |
| `--config` | 要更新的 YAML 配置文件路径 | `None` |
| `--force` | 强制重新计算 | `False` |
| `--splits` | 要处理的数据集划分（如 `train val`） | 全部 |
| `--num-bins` | Voxel 分箱数量 | `32` |

### GoPro 特定参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--spike-frames` | Spike 数据时间帧数 | `10` |
| `--spike-height` | Spike 数据高度 | `396` |
| `--spike-width` | Spike 数据宽度 | `640` |

### X4K 特定参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--fps` | 源视频帧率 | `1000` |
| `--exposure-frames` | 用于合成模糊的帧数 | `33` |

---

## 测试

### 运行测试脚本

```bash
# 运行测试脚本
python scripts/test_preprocessing.py
```

**预期输出**：
```
Testing GoPro Dataset...
✓ GoPro Dataset: Ready

Testing X4K Dataset...
⚠ X4K Dataset: Skipped (no raw data)

All tests completed!
```

### 手动测试

```python
# 测试 GoPro 预处理
from pathlib import Path
from src.data.preprocessing import get_preprocessor

preprocessor = get_preprocessor(
    dataset_type="gopro",
    data_root=Path("data/raw/gopro_spike"),
    output_root=Path("data/processed/gopro_test"),
)

# 检查就绪状态
is_ready = preprocessor.check_ready()
print(f"数据集准备状态: {is_ready}")

# 如果未准备好，执行预处理
if not is_ready:
    preprocessor.prepare()
    print("✓ 预处理完成")
```

---

## 常见问题

### Q1：预处理需要多长时间？

**A**：取决于数据集大小：
- GoPro (~2100 样本)：约 10-30 分钟
- X4K (~4000 样本)：约 30-60 分钟

时间主要花在：
- Spike 数据 voxelization
- 统计信息计算
- 文件复制和组织

### Q2：预处理失败了怎么办？

**A**：检查以下几点：
1. 原始数据路径是否正确
2. 原始数据结构是否符合预期
3. 磁盘空间是否充足
4. 是否有写入权限

使用 `--action check` 命令可以帮助诊断问题。

### Q3：可以只处理 train 或 val 吗？

**A**：可以使用 `--splits` 参数：
```bash
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /path/to/raw \
    --output-root /path/to/processed \
    --splits train
```

### Q4：如何强制重新预处理？

**A**：使用 `--force` 参数：
```bash
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /path/to/raw \
    --output-root /path/to/processed \
    --force
```

### Q5：预处理的数据可以复用吗？

**A**：可以。预处理后的数据是标准格式，可以在不同的训练配置中复用。只需在配置文件中更新 `DATA.ROOT` 指向预处理后的路径即可。

### Q6：训练时如何使用预处理的数据？

**A**：两种方式：

**方式1：手动预处理**
```bash
# 先预处理
python -m src.data.preprocessing --dataset gopro ...

# 再训练
python src/train.py --config configs/deblur/vrt_spike_baseline.yaml
```

**方式2：自动预处理**
```yaml
# 在配置文件中设置
DATA:
  PREPROCESSING:
    AUTO_PREPARE: true
```

然后直接训练：
```bash
python src/train.py --config configs/deblur/vrt_spike_baseline.yaml
```

---

## 获取帮助

### 查看命令行帮助

```bash
python -m src.data.preprocessing --help
```

### 详细文档

查看完整的预处理文档（如果存在）：
```bash
cat docs/PREPROCESSING.md
```

### 实现细节

查看实现摘要（如果存在）：
```bash
cat PREPROCESSING_IMPLEMENTATION.md
```

---

## 工作流程示例

### 新项目开始

```bash
# 1. 检查原始数据
ls /mnt/data/gopro_spike/train/

# 2. 检查数据集就绪状态
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --action check

# 3. 如果未准备好，执行预处理
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --action prepare

# 4. 验证预处理结果
ls data/processed/gopro_unified/train/
ls data/processed/gopro_unified/train/spike_vox/
cat data/processed/gopro_unified/stats.json

# 5. 开始训练
bash scripts/launch_train.sh
```

### 更新数据集

```bash
# 如果原始数据有更新，强制重新预处理
python -m src.data.preprocessing \
    --dataset gopro \
    --data-root /mnt/data/gopro_spike \
    --output-root data/processed/gopro_unified \
    --config configs/deblur/vrt_spike_baseline.yaml \
    --force
```

### 切换数据集

```bash
# 从 GoPro 切换到 X4K

# 1. 预处理 X4K 数据
python -m src.data.preprocessing \
    --dataset x4k \
    --data-root /mnt/data/x4k1000fps \
    --output-root data/processed/x4k_unified \
    --config configs/deblur/vrt_spike_baseline.yaml

# 2. 更新配置文件
# 编辑 configs/deblur/vrt_spike_baseline.yaml:
# DATA:
#   ROOT: data/processed/x4k_unified
#   PREPROCESSING:
#     DATASET_TYPE: "x4k"

# 3. 开始训练
bash scripts/launch_train.sh
```

---

## 架构概览

### 模块结构

```
src/data/preprocessing/
├── __init__.py              # 工厂函数和导出
├── __main__.py              # CLI 入口点
├── core/
│   ├── __init__.py
│   ├── voxelizer.py         # Spike voxelization
│   ├── statistics.py        # 数据集统计计算
│   ├── config_updater.py    # YAML 配置更新工具
│   └── alignment.py         # 时间对齐工具
└── datasets/
    ├── __init__.py
    ├── base.py              # BasePreprocessor 抽象类
    ├── gopro.py             # GoPro 特定预处理器
    └── x4k.py               # X4K 特定预处理器
```

### 关键类

**BasePreprocessor**：
- `prepare()`: 完整预处理流程
- `check_ready()`: 验证数据集就绪状态
- `compute_stats()`: 计算归一化统计信息
- `update_config()`: 更新 YAML 配置文件

**GoProPreprocessor**：
- 处理二进制 `.dat` spike 文件
- Spike 数据 voxelization
- GoPro 特定目录结构

**X4KPreprocessor**：
- 高帧率视频对齐
- 从清晰序列合成模糊图像
- Spike-RGB 时间对齐

---

## 高级特性

### 添加新数据集

要添加新的数据集类型：

1. 在 `src/data/preprocessing/datasets/` 创建新文件（如 `mydataset.py`）
2. 继承 `BasePreprocessor` 类
3. 实现数据集特定的方法
4. 在 `__init__.py` 中注册

示例：
```python
from .base import BasePreprocessor

class MyDatasetPreprocessor(BasePreprocessor):
    def _validate_input(self):
        """验证输入数据"""
        # 实现你的验证逻辑
        pass
    
    def _process_split(self, split):
        """处理数据集划分"""
        # 实现你的处理逻辑
        pass
```

### 自定义 Voxelization

可以自定义 voxelization 参数：
```python
preprocessor = get_preprocessor(
    dataset_type="gopro",
    data_root=Path("/path/to/raw"),
    output_root=Path("/path/to/processed"),
    num_bins=64,  # 增加分箱数
)
```

### 分布式训练集成

预处理器已集成到训练脚本中，支持分布式训练：
- 只有 rank 0 进程执行预处理
- 其他进程等待预处理完成
- 通过 `dist.barrier()` 同步

---

**需要更多帮助？** 请参考代码注释或提交 issue。

